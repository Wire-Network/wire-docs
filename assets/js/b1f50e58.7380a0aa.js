"use strict";(self.webpackChunkwire_docs=self.webpackChunkwire_docs||[]).push([[3445],{80438:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>c});var o=n(74848),t=n(28453);const s={},a=void 0,r={id:"api-reference/tooling/nodeop/plugins/trace-api-plugin",title:"trace-api-plugin",description:"Overview",source:"@site/docs/api-reference/tooling/nodeop/plugins/trace-api-plugin.md",sourceDirName:"api-reference/tooling/nodeop/plugins",slug:"/api-reference/tooling/nodeop/plugins/trace-api-plugin",permalink:"/docs/api-reference/tooling/nodeop/plugins/trace-api-plugin",draft:!1,unlisted:!1,editUrl:"https://github.com/Wire-Network/wire-docs/edit/master/docs/api-reference/tooling/nodeop/plugins/trace-api-plugin.md",tags:[],version:"current",frontMatter:{},sidebar:"apiReferenceSidebar",previous:{title:"state-history-plugin",permalink:"/docs/api-reference/tooling/nodeop/plugins/state-history-plugin"},next:{title:"txn-test-gen-plugin",permalink:"/docs/api-reference/tooling/nodeop/plugins/txn-test-gen-plugin"}},l={},c=[{value:"Overview",id:"overview",level:2},{value:"Purpose",id:"purpose",level:2},{value:"Usage",id:"usage",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Load Dependency Examples",id:"load-dependency-examples",level:3},{value:"Configuration Example",id:"configuration-example",level:2},{value:"Definitions",id:"definitions",level:2},{value:"Slices",id:"slices",level:3},{value:"trace_&lt;S&gt;-&lt;E&gt;.log",id:"trace_s-elog",level:4},{value:"trace_index_&lt;S&gt;-&lt;E&gt;.log",id:"trace_index_s-elog",level:4},{value:"clog format",id:"clog-format",level:3},{value:"Role of seek points",id:"role-of-seek-points",level:4},{value:"Automatic Maintenance",id:"automatic-maintenance",level:2},{value:"Removal of log files",id:"removal-of-log-files",level:3},{value:"Compression of log files",id:"compression-of-log-files",level:3},{value:"Manual Maintenance",id:"manual-maintenance",level:2}];function d(e){const i={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(i.h2,{id:"overview",children:"Overview"}),"\n",(0,o.jsxs)(i.p,{children:["The ",(0,o.jsx)(i.code,{children:"trace_api_plugin"})," provides a consumer-focused long-term API for retrieving retired actions and related metadata from a specified block. The plugin stores serialized block trace data to the filesystem for later retrieval via HTTP RPC requests. For detailed information about the definition of this application programming interface see the ",(0,o.jsx)(i.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:n(85950).A+"",children:"Trace API reference"}),"."]}),"\n",(0,o.jsx)(i.h2,{id:"purpose",children:"Purpose"}),"\n",(0,o.jsxs)(i.p,{children:["While integrating applications such as block explorers and exchanges with an Wire blockchain, the user might require a complete transcript of actions processed by the blockchain, including those spawned from the execution of smart contracts and scheduled transactions. The ",(0,o.jsx)(i.code,{children:"trace_api_plugin"})," serves this need. The purpose of the plugin is to provide:"]}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:"A transcript of retired actions and related metadata"}),"\n",(0,o.jsx)(i.li,{children:"A consumer-focused long-term API to retrieve blocks"}),"\n",(0,o.jsx)(i.li,{children:"Maintainable resource commitments at the Wire nodes"}),"\n"]}),"\n",(0,o.jsxs)(i.p,{children:["Therefore, one crucial goal of the ",(0,o.jsx)(i.code,{children:"trace_api_plugin"})," is to improve the maintenance of node resources (file system, disk space, memory used, etc.). This goal is different from the existing ",(0,o.jsx)(i.code,{children:"history_plugin"})," which provides far more configurable filtering and querying capabilities, or the existing ",(0,o.jsx)(i.code,{children:"state_history_plugin"})," which provides a binary streaming interface to access structural chain data, action data, as well as state deltas."]}),"\n",(0,o.jsx)(i.h2,{id:"usage",children:"Usage"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-console",children:"# config.ini\nplugin = sysio::trace_api_plugin\n[options]\n"})}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sh",children:"# command-line\nnodeop ... --plugin sysio::trace_api_plugin [options]\n"})}),"\n",(0,o.jsx)(i.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,o.jsxs)(i.p,{children:["These can be specified from both the ",(0,o.jsx)(i.code,{children:"nodeop"})," command-line or the ",(0,o.jsx)(i.code,{children:"config.ini"})," file:"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-console",children:'Config Options for sysio::trace_api_plugin:\n\n  --trace-dir arg (="traces")           the location of the trace directory \n                                        (absolute path or relative to \n                                        application data dir)\n  --trace-slice-stride arg (=10000)     the number of blocks each "slice" of \n                                        trace data will contain on the \n                                        filesystem\n  --trace-minimum-irreversible-history-blocks arg (=-1)\n                                        Number of blocks to ensure are kept \n                                        past LIB for retrieval before "slice" \n                                        files can be automatically removed.\n                                        A value of -1 indicates that automatic \n                                        removal of "slice" files will be turned\n                                        off.\n  --trace-minimum-uncompressed-irreversible-history-blocks arg (=-1)\n                                        Number of blocks to ensure are \n                                        uncompressed past LIB. Compressed \n                                        "slice" files are still accessible but \n                                        may carry a performance loss on \n                                        retrieval\n                                        A value of -1 indicates that automatic \n                                        compression of "slice" files will be \n                                        turned off.\n  --trace-rpc-abi arg                   ABIs used when decoding trace RPC \n                                        responses.\n                                        There must be at least one ABI \n                                        specified OR the flag trace-no-abis \n                                        must be used.\n                                        ABIs are specified as "Key=Value" pairs\n                                        in the form <account-name>=<abi-def>\n                                        Where <abi-def> can be:\n                                           an absolute path to a file \n                                        containing a valid JSON-encoded ABI\n                                           a relative path from `data-dir` to a\n                                        file containing a valid JSON-encoded \n                                        ABI\n                                        \n  --trace-no-abis                       Use to indicate that the RPC responses \n                                        will not use ABIs.\n                                        Failure to specify this option when \n                                        there are no trace-rpc-abi \n                                        configuations will result in an Error.\n                                        This option is mutually exclusive with \n                                        trace-rpc-api\n'})}),"\n",(0,o.jsx)(i.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"/docs/api-reference/tooling/nodeop/plugins/chain-plugin",children:(0,o.jsx)(i.code,{children:"chain_plugin"})})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"/docs/api-reference/tooling/nodeop/plugins/http-plugin",children:(0,o.jsx)(i.code,{children:"http_plugin"})})}),"\n"]}),"\n",(0,o.jsx)(i.h3,{id:"load-dependency-examples",children:"Load Dependency Examples"}),"\n",(0,o.jsxs)(i.p,{children:["The following plugins are loaded with default settings if not specified on the command line or ",(0,o.jsx)(i.code,{children:"config.ini"}),":"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-console",children:"# config.ini\nplugin = sysio::chain_plugin\n[options]\nplugin = sysio::http_plugin \n[options]\n"})}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sh",children:"# command-line\nnodeop ... --plugin sysio::chain_plugin [options]  \\\n           --plugin sysio::http_plugin [options]\n"})}),"\n",(0,o.jsx)(i.h2,{id:"configuration-example",children:"Configuration Example"}),"\n",(0,o.jsxs)(i.p,{children:["Here is a ",(0,o.jsx)(i.code,{children:"nodeop"})," configuration example for the ",(0,o.jsx)(i.code,{children:"trace_api_plugin"})," when tracing some system contracts:"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sh",children:"nodeop --data-dir data_dir --config-dir config_dir --trace-dir traces_dir\n--plugin sysio::trace_api_plugin \n--trace-rpc-abi=sysio=abis/sysio.abi \n--trace-rpc-abi=sysio.token=abis/sysio.token.abi \n--trace-rpc-abi=sysio.msig=abis/sysio.msig.abi \n--trace-rpc-abi=sysio.wrap=abis/sysio.wrap.abi\n"})}),"\n",(0,o.jsx)(i.h2,{id:"definitions",children:"Definitions"}),"\n",(0,o.jsxs)(i.p,{children:["This section provides an overview of ",(0,o.jsx)(i.em,{children:"slices"}),", the ",(0,o.jsx)(i.em,{children:"trace log"})," contents, and the ",(0,o.jsx)(i.em,{children:"clog format"}),". Mastery of these concepts is beneficial for an effective use of the ",(0,o.jsx)(i.code,{children:"trace_api_plugin"})," options."]}),"\n",(0,o.jsx)(i.h3,{id:"slices",children:"Slices"}),"\n",(0,o.jsxs)(i.p,{children:["In the context of the ",(0,o.jsx)(i.code,{children:"trace_api_plugin"}),", a ",(0,o.jsx)(i.em,{children:"slice"})," is defined as a collection of all relevant trace data between a given starting block height (inclusive) and a given ending block height (exclusive). For instance, a slice from 0 to 10,000 is a collection of all blocks with block numbers greater than or equal to 0 and less than 10,000. The trace directory contains a collection of slices. Each slice consists of a ",(0,o.jsx)(i.em,{children:"trace data"})," log file and a ",(0,o.jsx)(i.em,{children:"trace index"})," metadata log file:"]}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.code,{children:"trace_<S>-<E>.log"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.code,{children:"trace_index_<S>-<E>.log"})}),"\n"]}),"\n",(0,o.jsxs)(i.p,{children:["where ",(0,o.jsx)(i.code,{children:"<S>"})," and ",(0,o.jsx)(i.code,{children:"<E>"})," are the starting and ending block numbers for the slice padded with leading 0's to a stride. For instance if the start block is 5, the last is 15, and the stride is 10, then the resulting ",(0,o.jsx)(i.code,{children:"<S>"})," is ",(0,o.jsx)(i.code,{children:"0000000005"})," and ",(0,o.jsx)(i.code,{children:"<E>"})," is ",(0,o.jsx)(i.code,{children:"0000000015"}),"."]}),"\n",(0,o.jsx)(i.h4,{id:"trace_s-elog",children:"trace_<S>-<E>.log"}),"\n",(0,o.jsx)(i.p,{children:"The trace data log is an append only log that stores the actual binary serialized block data. The contents include the transaction and action trace data needed to service the RPC requests augmented by the per-action ABIs. Two block types are supported:"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.code,{children:"block_trace_v0"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.code,{children:"block_trace_v1"})}),"\n"]}),"\n",(0,o.jsxs)(i.p,{children:["The data log begins with a basic header that includes versioning information about the data stored in the log. ",(0,o.jsx)(i.code,{children:"block_trace_v0"})," includes the block ID, block number, previous block ID, the production timestamp, the producer that signed the block, and the actual trace data. ",(0,o.jsx)(i.code,{children:"block_trace_v1"})," adds both merkle root hashes for the list of transactions and the list of actions included in the block as well as the production schedule count since genesis."]}),"\n",(0,o.jsxs)(i.p,{children:["The log may include blocks that have been forked out of the blockchain as part of the normal operations of the chain. The next entry in the file will always have a block number one higher than the previous one or the same number or less because of forking.  Every trace entry will have a corresponding entry in the corresponding slice file for trace indexes. Note that forked blocks can be avoided by running nodeop in ",(0,o.jsx)(i.code,{children:"read-mode=irreversible"}),"."]}),"\n",(0,o.jsx)(i.h4,{id:"trace_index_s-elog",children:"trace_index_<S>-<E>.log"}),"\n",(0,o.jsx)(i.p,{children:"The trace index log or metadata log is an append only log that stores a sequence of binary-serialized types. Currently two types are supported:"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.code,{children:"block_entry_v0"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.code,{children:"lib_entry_v0"})}),"\n"]}),"\n",(0,o.jsxs)(i.p,{children:["The index log begins with a basic header that includes versioning information about the data stored in the log. ",(0,o.jsx)(i.code,{children:"block_entry_v0"})," includes the block ID and block number with an offset to the location of that block within the data log. This entry is used to locate the offsets of both ",(0,o.jsx)(i.code,{children:"block_trace_v0"})," and ",(0,o.jsx)(i.code,{children:"block_trace_v1"})," blocks. ",(0,o.jsx)(i.code,{children:"lib_entry_v0"})," includes an entry for the latest known LIB. The reader module uses the LIB information for reporting to users an irreversible status."]}),"\n",(0,o.jsx)(i.h3,{id:"clog-format",children:"clog format"}),"\n",(0,o.jsxs)(i.p,{children:["Compressed trace log files have the ",(0,o.jsx)(i.code,{children:".clog"})," file extension (see ",(0,o.jsx)(i.a,{href:"#compression-of-log-files",children:"Compression of log files"})," below). The clog is a generic compressed file with an index of seek-able decompression points appended at the end. The clog format layout looks as follows:"]}),"\n",(0,o.jsx)(i.p,{children:(0,o.jsx)(i.img,{alt:"clog-format",src:n(70348).A+"",width:"678",height:"282"})}),"\n",(0,o.jsxs)(i.p,{children:["The data is compressed into raw zlib form with full-flush ",(0,o.jsx)(i.em,{children:"seek points"})," placed at regular intervals. A decompressor can start from any of these ",(0,o.jsx)(i.em,{children:"seek points"})," without reading previous data and it can also traverse a seek point without issue if it appears within the data."]}),"\n",(0,o.jsx)(i.admonition,{title:"Size reduction of trace logs",type:"info",children:(0,o.jsxs)(i.p,{children:["| Data compression can reduce the space growth of trace logs twentyfold! For instance, with 512 seek points and using the test dataset on the EOS public network, data compression reduces the growth of the trace directory from ~50 GiB/day to ~2.5 GiB/day for full data. Due to the high redundancy of the trace log contents, the compression is still comparable to ",(0,o.jsx)(i.code,{children:"gzip -9"}),". The decompressed data is also made immediately available via the ",(0,o.jsx)(i.a,{href:"/docs/api-reference/trace-api/",children:"Trace RPC API"})," without any service degradation."]})}),"\n",(0,o.jsx)(i.h4,{id:"role-of-seek-points",children:"Role of seek points"}),"\n",(0,o.jsx)(i.p,{children:"As the file is being compressed, the seek point index records the original uncompressed offset with the new compressed offset creating a mapping so that the original index values (uncompressed offsets) can be mapped to the nearest seek point before the uncompressed offset. This dramatically reduces the seek time to parts of the uncompressed file that appear later in the stream."}),"\n",(0,o.jsx)(i.h2,{id:"automatic-maintenance",children:"Automatic Maintenance"}),"\n",(0,o.jsxs)(i.p,{children:["One of the main design goals of the ",(0,o.jsx)(i.code,{children:"trace_api_plugin"})," is to minimize the manual housekeeping and maintenance of filesystem resources. To that end, the plugin facilitates the automatic removal of trace log files and the automatic reduction of their disk footprint through data compression."]}),"\n",(0,o.jsx)(i.h3,{id:"removal-of-log-files",children:"Removal of log files"}),"\n",(0,o.jsxs)(i.p,{children:["To allow the removal of previous trace log files created by the ",(0,o.jsx)(i.code,{children:"trace_api_plugin"}),", you can use the following option:"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sh",children:"  --trace-minimum-irreversible-history-blocks N (=-1) \n"})}),"\n",(0,o.jsxs)(i.p,{children:["If the argument ",(0,o.jsx)(i.code,{children:"N"})," is 0 or greater, the plugin will only keep ",(0,o.jsx)(i.code,{children:"N"})," blocks on disk before the current LIB block. Any trace log file with block numbers lesser than then previous ",(0,o.jsx)(i.code,{children:"N"})," blocks will be scheduled for automatic removal."]}),"\n",(0,o.jsx)(i.h3,{id:"compression-of-log-files",children:"Compression of log files"}),"\n",(0,o.jsxs)(i.p,{children:["The ",(0,o.jsx)(i.code,{children:"trace_api_plugin"})," also supports an option to optimize disk space by applying data compression on the trace log files:"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sh",children:"  --trace-minimum-uncompressed-irreversible-history-blocks N (=-1)\n"})}),"\n",(0,o.jsxs)(i.p,{children:["If the argument ",(0,o.jsx)(i.code,{children:"N"})," is 0 or greater, the plugin automatically sets a background thread to compress the irreversible sections of the trace log files. The previous N irreversible blocks past the current LIB block are left uncompressed."]}),"\n",(0,o.jsx)(i.admonition,{title:"Trace API utility",type:"info",children:(0,o.jsxs)(i.p,{children:["| The trace log files can also be compressed manually with the ",(0,o.jsx)(i.a,{href:"/docs/api-reference/tooling/utilities/trace-api-util",children:"trace_api_util"})," utility."]})}),"\n",(0,o.jsxs)(i.p,{children:["If resource usage cannot be effectively managed via the ",(0,o.jsx)(i.code,{children:"trace-minimum-irreversible-history-blocks"})," and ",(0,o.jsx)(i.code,{children:"trace-minimum-uncompressed-irreversible-history-blocks"})," options, then there might be a need for periodic manual maintenance. In that case, the user may opt to manage resources through an external system or recurrent process."]}),"\n",(0,o.jsx)(i.h2,{id:"manual-maintenance",children:"Manual Maintenance"}),"\n",(0,o.jsxs)(i.p,{children:["The ",(0,o.jsx)(i.code,{children:"trace-dir"})," option defines the directory on the filesystem where the trace log files are stored by the ",(0,o.jsx)(i.code,{children:"trace_api_plugin"}),". These files are stable once the LIB block has progressed past a given slice and then can be deleted at any time to reclaim filesystem space. The deployed system contract will tolerate any out-of-process management system that removes some or all of these files in this directory regardless of what data they represent, or whether there is a running ",(0,o.jsx)(i.code,{children:"nodeop"})," instance accessing them or not.  Data which would nominally be available, but is no longer so due to manual maintenance, will result in a HTTP 404 response from the appropriate API endpoint(s)."]}),"\n",(0,o.jsx)(i.admonition,{title:"For node operators",type:"info",children:(0,o.jsxs)(i.p,{children:["| Node operators can take full control over the lifetime of the historical data available in their nodes via the ",(0,o.jsx)(i.code,{children:"trace-api-plugin"})," and the ",(0,o.jsx)(i.code,{children:"trace-minimum-irreversible-history-blocks"})," and ",(0,o.jsx)(i.code,{children:"trace-minimum-uncompressed-irreversible-history-blocks"})," options in conjunction with any external filesystem resource manager."]})})]})}function h(e={}){const{wrapper:i}={...(0,t.R)(),...e.components};return i?(0,o.jsx)(i,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},85950:(e,i,n)=>{n.d(i,{A:()=>o});const o=n.p+"assets/files/TraceApi-5e0d6ac86ad7429853621b4f8daa8476.yaml"},70348:(e,i,n)=>{n.d(i,{A:()=>o});const o=n.p+"assets/images/clog-format-fd9184d01472d7b3679c612c2ad98ed1.png"},28453:(e,i,n)=>{n.d(i,{R:()=>a,x:()=>r});var o=n(96540);const t={},s=o.createContext(t);function a(e){const i=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),o.createElement(s.Provider,{value:i},e.children)}}}]);